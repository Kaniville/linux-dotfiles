#!/bin/python3

from urllib.request import urlopen, urlretrieve
from json import loads
from os import listdir, path
from random import choice
from subprocess import run
from argparse import ArgumentParser

# Argument parser setup
argument_parser = ArgumentParser()
argument_parser.add_argument('-r', '--random', required=False, help='Select a random wallpaper from the given directory')
argument_parser.add_argument('-b', '--bing', action='store_true', help='Change the wallpaper to the current Bing wallpaper')
option = argument_parser.parse_args()


# Download the current Bing Wallpaper and set it
def bing_wallpaper():
    background_dir = path.abspath(path.expanduser('~/.cache'))
    bing_url = 'https://www.bing.com/HPImageArchive.aspx?format=js&idx=0&n=1&mkt=fr-FR'

    # Get Json
    try:
        bing_json = loads(urlopen(bing_url).read().decode("utf-8"))
    except:
        exit("Please check your connection.")

    # Select the wallpaper from the Json
    wallpaper_url = "https://bing.com" + bing_json['images'][0]['url']
    wallpaper_file = f'{background_dir}/background.jpg'

    # Download the wallpaper and set it
    try:
        urlretrieve(wallpaper_url, wallpaper_file)
        set_wallpaper(wallpaper_file)
    except:
        exit("Please check your connection.")


# Get random wallpaper from a selected directory and set it
def random_wallpaper():
    background_dir = path.abspath(path.expanduser(option.random))
    random_wallpaper = choice(listdir(background_dir))
    wallpaper_file = f'{background_dir}/{random_wallpaper}'

    set_wallpaper(wallpaper_file)


# Set gnome wallpaper
def set_wallpaper(wallpaper_file):
    try:
        run(['gsettings', 'set', 'org.gnome.desktop.background', 'picture-uri', f'file://{wallpaper_file}'], check=True)
        run(['gsettings', 'set', 'org.gnome.desktop.background', 'picture-uri-dark', f'file://{wallpaper_file}'], check=True)
    except:
        exit("Please check that the chosen file is an image.")


# Select an option
if option.bing:
    bing_wallpaper()
if option.random:
    random_wallpaper()
